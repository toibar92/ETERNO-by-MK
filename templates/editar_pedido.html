{% extends "base.html" %}

{% block title %}Editar Pedido - ETERNO by MK{% endblock %}

{% block extra_css %}
<style>
    .calculation-box {
        background-color: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 5px;
    }
    
    .calculation-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .calculation-item:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 1.1rem;
        padding-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-pencil"></i> Editar Pedido - {{ pedido.cliente }}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="pedidoForm">
                    <div class="row">
                        <!-- Información Básica -->
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-info-circle"></i> Información Básica
                            </h6>
                            
                            <div class="mb-3">
                                <label for="fecha" class="form-label">Fecha del Pedido *</label>
                                <input type="date" class="form-control" id="fecha" name="fecha" 
                                       value="{{ pedido.fecha.strftime('%Y-%m-%d') if pedido.fecha else '' }}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="cliente" class="form-label">Cliente *</label>
                                <input type="text" class="form-control" id="cliente" name="cliente" 
                                       value="{{ pedido.cliente }}" placeholder="Nombre del cliente" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="producto" class="form-label">Producto *</label>
                                <select class="form-select" id="producto" name="producto" required>
                                    {% for nombre, config in productos.items() %}
                                    <option value="{{ nombre }}" {% if pedido.producto == nombre %}selected{% endif %}>
                                        {{ nombre }} - {{ config.medidas }} - Q{{ config.precio }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="cantidad" class="form-label">Cantidad *</label>
                                <input type="number" class="form-control" id="cantidad" name="cantidad" 
                                       min="1" value="{{ pedido.cantidad }}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="descuento" class="form-label">Descuento (%)</label>
                                <input type="number" class="form-control" id="descuento" name="descuento" 
                                       min="0" max="100" step="0.01" value="{{ (pedido.descuento * 100)|round(2) if pedido.descuento else 0 }}">
                            </div>
                        </div>
                        
                        <!-- Información de Pago -->
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-cash"></i> Información de Pago
                            </h6>
                            
                            <div class="mb-3">
                                <label for="anticipo" class="form-label">Anticipo</label>
                                <div class="input-group">
                                    <span class="input-group-text">Q</span>
                                    <input type="number" class="form-control" id="anticipo" name="anticipo" 
                                           min="0" step="0.01" value="{{ pedido.anticipo if pedido.anticipo else 0 }}">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="metodo_pago_anticipo" class="form-label">Método de Pago - Anticipo</label>
                                <select class="form-select" id="metodo_pago_anticipo" name="metodo_pago_anticipo">
                                    <option value="">Seleccionar...</option>
                                    {% for metodo in metodos_pago %}
                                    <option value="{{ metodo }}" {% if pedido.metodo_pago_anticipo == metodo %}selected{% endif %}>
                                        {{ metodo }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="cuotas_visa_anticipo" class="form-label">Cuotas VISA - Anticipo</label>
                                <select class="form-select" id="cuotas_visa_anticipo" name="cuotas_visa_anticipo">
                                    <option value="0">Sin cuotas</option>
                                    {% for cuotas, porcentaje in costos_visa.items() %}
                                    <option value="{{ cuotas }}" {% if pedido.cuotas_visa_anticipo == cuotas %}selected{% endif %}>
                                        {{ cuotas }} cuotas ({{ "%.1f"|format(porcentaje * 100) }}%)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="fecha_sesion" class="form-label">Fecha de Sesión</label>
                                <input type="date" class="form-control" id="fecha_sesion" name="fecha_sesion" 
                                       value="{{ pedido.fecha_sesion.strftime('%Y-%m-%d') if pedido.fecha_sesion else '' }}">
                                <small class="text-muted">Fecha en que se entregará el saldo</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="metodo_pago_saldo" class="form-label">Método de Pago - Saldo</label>
                                <select class="form-select" id="metodo_pago_saldo" name="metodo_pago_saldo">
                                    <option value="Pendiente">Pendiente</option>
                                    {% for metodo in metodos_pago %}
                                    <option value="{{ metodo }}" {% if pedido.metodo_pago_saldo == metodo %}selected{% endif %}>
                                        {{ metodo }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="cuotas_visa_saldo" class="form-label">Cuotas VISA - Saldo</label>
                                <select class="form-select" id="cuotas_visa_saldo" name="cuotas_visa_saldo">
                                    <option value="0">Sin cuotas</option>
                                    {% for cuotas, porcentaje in costos_visa.items() %}
                                    <option value="{{ cuotas }}" {% if pedido.cuotas_visa_saldo == cuotas %}selected{% endif %}>
                                        {{ cuotas }} cuotas ({{ "%.1f"|format(porcentaje * 100) }}%)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resumen de Cálculo -->
                    <div class="calculation-box" id="calculationBox">
                        <h6><i class="bi bi-calculator"></i> Resumen del Pedido</h6>
                        <div id="calculationContent">
                            <p class="text-muted mb-0">Calculando...</p>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Guardar Cambios
                        </button>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <a href="{{ url_for('eliminar_pedido', pedido_id=pedido.id) }}" 
                           class="btn btn-danger" 
                           onclick="return confirm('¿Estás seguro de eliminar este pedido?')">
                            <i class="bi bi-trash"></i> Eliminar Pedido
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const productos = {{ productos|tojson }};
const costosVisa = {{ costos_visa|tojson }};

function calcularResumen() {
    const producto = document.getElementById('producto').value;
    const cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
    const descuento = parseFloat(document.getElementById('descuento').value) || 0;
    const anticipo = parseFloat(document.getElementById('anticipo').value) || 0;
    const cuotasAnticipo = parseInt(document.getElementById('cuotas_visa_anticipo').value) || 0;
    const cuotasSaldo = parseInt(document.getElementById('cuotas_visa_saldo').value) || 0;
    
    if (!producto || cantidad === 0) return;
    
    const config = productos[producto];
    const precioUnitario = config.precio;
    const subtotal = precioUnitario * cantidad;
    const totalVenta = subtotal * (1 - descuento / 100);
    const saldoRestante = totalVenta - anticipo;
    
    const costoVisaAnticipo = cuotasAnticipo > 0 ? anticipo * (costosVisa[cuotasAnticipo] || 0) : 0;
    const costoVisaSaldo = cuotasSaldo > 0 ? saldoRestante * (costosVisa[cuotasSaldo] || 0) : 0;
    const costoVisaTotal = costoVisaAnticipo + costoVisaSaldo;
    
    let costoProduccion = 0;
    for (let item in config.costos) {
        costoProduccion += config.costos[item] * cantidad;
    }
    
    const costoTotal = costoProduccion + costoVisaTotal;
    const utilidad = totalVenta - costoTotal;
    const porcentajeUtilidad = totalVenta > 0 ? (utilidad / totalVenta * 100) : 0;
    
    const html = `
        <div class="calculation-item">
            <span>Subtotal:</span>
            <span>Q${subtotal.toFixed(2)}</span>
        </div>
        <div class="calculation-item">
            <span>Total Venta:</span>
            <span>Q${totalVenta.toFixed(2)}</span>
        </div>
        <div class="calculation-item">
            <span>Anticipo:</span>
            <span class="text-success">Q${anticipo.toFixed(2)}</span>
        </div>
        <div class="calculation-item">
            <span>Saldo Restante:</span>
            <span class="text-warning">Q${saldoRestante.toFixed(2)}</span>
        </div>
        <div class="calculation-item">
            <span>Costo Total:</span>
            <span class="text-danger">Q${costoTotal.toFixed(2)}</span>
        </div>
        <div class="calculation-item">
            <span>Utilidad:</span>
            <span class="${utilidad > 0 ? 'text-success' : 'text-danger'}">
                Q${utilidad.toFixed(2)} (${porcentajeUtilidad.toFixed(1)}%)
            </span>
        </div>
    `;
    
    document.getElementById('calculationContent').innerHTML = html;
}

document.getElementById('producto').addEventListener('change', calcularResumen);
document.getElementById('cantidad').addEventListener('input', calcularResumen);
document.getElementById('descuento').addEventListener('input', calcularResumen);
document.getElementById('anticipo').addEventListener('input', calcularResumen);
document.getElementById('cuotas_visa_anticipo').addEventListener('change', calcularResumen);
document.getElementById('cuotas_visa_saldo').addEventListener('change', calcularResumen);

// Calcular al cargar
document.addEventListener('DOMContentLoaded', calcularResumen);
</script>
{% endblock %}
